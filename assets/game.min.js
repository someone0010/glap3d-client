var logger=document.getElementById("game-log"),stats=document.getElementById("stats"),serverUrl="wss://server.glap3d.ga",powertext=document.getElementById("power_state"),powerbar=document.getElementById("powerBar"),velocitytext=document.getElementById("velocity_state"),velocitybar=document.getElementById("velocityBar"),pitchtext=document.getElementById("pitch_state"),yawtext=document.getElementById("yaw_state"),rolltext=document.getElementById("roll_state"),playerTextName=document.getElementById("playername"),joinButton=document.getElementById("join-button"),affiliateGlap=document.getElementById("glap-seo-opt"),loadingText=document.getElementById("loadState"),loadScreen=document.getElementById("splash");joinButton.disabled=!0;var dataPool=0,settingsData={gq:{setting:["Low","Medium","High","Ultra"],current:3,critical:!0},sk:{setting:["Low","Medium","High","Ultra"],current:3,critical:!0},shd:{setting:["Low","Medium","High","Ultra"],current:3},gd:{setting:["Off","On"],current:1,critical:!0},bl:{setting:["Off","On"],current:1,critical:!0},dof:{setting:["Off","On"],current:1,critical:!0},aa:{setting:["Off","Low","Medium","High","Ultra"],current:1,critical:!0},ao:{setting:["Off","On"],current:1},ptd:{setting:["Off","On"],current:1},jg:{setting:["Off","On"],current:1},flt:{setting:["Off","Linear","Realistic","Cinematic"],current:1}},loadedsettings=JSON.parse(localStorage.getItem("settingsData"))||{gq:1,sk:1,shd:1,gd:1,bl:1,dof:1,aa:1,ao:1,ptd:1,jg:1};if("object"==typeof loadedsettings.gq){var i={};for(let[e,t]of Object.entries(settingsData))i[e]=t.current;localStorage.setItem("settingsData",JSON.stringify(i))}for(let[e,t]of Object.entries(loadedsettings))settingsData[e].current=t;document.querySelector("div.reload-alert").style.display="none";for(let[e,t]of Object.entries(settingsData))settingsData[e].textelem=document.getElementById(e+"_text"),settingsData[e].textelem.innerText=settingsData[e].setting[settingsData[e].current],document.getElementById(e+"_left").addEventListener("click",function(){settingsData[e].current=Math.max(0,settingsData[e].current-1),settingsData[e].textelem.innerText=settingsData[e].setting[settingsData[e].current]}),document.getElementById(e+"_right").addEventListener("click",function(){settingsData[e].current=Math.min(settingsData[e].setting.length-1,settingsData[e].current+1),settingsData[e].textelem.innerText=settingsData[e].setting[settingsData[e].current]});var settingsOn=!1;document.getElementById("settings-button").addEventListener("click",()=>{settingsOn=!0,document.querySelector(".settings").style.display="block"}),document.getElementById("cancel-button").addEventListener("click",()=>{settingsOn=!1,document.querySelector(".settings").style.display="none"}),document.getElementById("apply-button").addEventListener("click",()=>{var e={};for(let[t,n]of Object.entries(settingsData))e[t]=n.current;localStorage.setItem("settingsData",JSON.stringify(e)),settingsOn=!1,document.querySelector(".settings").style.display="none"}),document.getElementById("join-button").querySelector("div").innerText="Loading..";const downscale=256,detail=192;function log(e){if(logger.innerHTML.endsWith(e+"</div>"))logger.lastChild.textContent=logger.lastChild.textContent+" (x2)";else if(logger.innerHTML.endsWith(e+" (x2)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x2)","")+" (x3)";else if(logger.innerHTML.endsWith(e+" (x3)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x3)","")+" (x4)";else if(logger.innerHTML.endsWith(e+" (x4)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x4)","")+" (x5)";else if(logger.innerHTML.endsWith(e+" (x5)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x5)","")+" (x6)";else if(logger.innerHTML.endsWith(e+" (x6)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x6)","")+" (x7)";else if(logger.innerHTML.endsWith(e+" (x7)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x7)","")+" (x8)";else if(logger.innerHTML.endsWith(e+" (x8)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x8)","")+" (x9)";else if(logger.innerHTML.endsWith(e+" (x9)</div>"))logger.lastChild.textContent=logger.lastChild.textContent.replace(" (x9)","")+" (x10)";else{logger.children.length>20&&logger.firstChild.remove();var t=document.createElement("div");t.innerHTML=e,t.setAttribute("class","gameLogText"),logger.appendChild(t),setTimeout(()=>{t.parentNode.removeChild(t)},1e4)}}class player{constructor(){}drawtext3d(e,t,n){var a=document.createElement("canvas"),s=a.getContext("2d");s.font=n;var r=s.measureText(e);a.height=parseInt(s.font.match(/\d+/),10),a.width=r.width,s.fillText(e,0,0);var i=new THREE.Texture(a);t.map=i;var o=new THREE.PlaneBufferGeometry(a.width,a.height);return new THREE.Mesh(o,t)}async init(){var e,t,n=document.createElement("canvas");try{i=n.getContext("webgl")||n.getContext("experimental-webgl")}catch(e){}if(!i)return void(loadingText.innerHTML="Could not start. Your graphics card or your browser does not support WebGL.");e=i.getExtension("WEBGL_debug_renderer_info"),i.getParameter(e.UNMASKED_VENDOR_WEBGL),t=i.getParameter(e.UNMASKED_RENDERER_WEBGL);var a=!1,s=new THREE.Scene,r=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.01,4e5);setInterval(this.everysecond,1e3);var i=(n=document.createElement("canvas")).getContext("webgl2",{alpha:!1}),o=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,powerPreference:"high-performance",context:i,canvas:n});switch(o.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(n),settingsData.flt.current){case 0:o.toneMapping=THREE.NoToneMapping;break;case 1:o.toneMapping=THREE.LinearToneMapping;break;case 2:o.toneMapping=THREE.ReinhardToneMapping;break;case 3:o.toneMapping=THREE.ACESFilmicToneMapping}window.addEventListener("resize",function(){r.aspect=window.innerWidth/window.innerHeight,o.setSize(window.innerWidth,window.innerHeight),ge.setSize(window.innerWidth,window.innerHeight),r.updateProjectionMatrix()},!1);loadingText.innerHTML="Creaing world (2/12)";var l=[],d=new THREE.SphereBufferGeometry(1e4/downscale,detail,detail),c=new THREE.SphereBufferGeometry(100/downscale,detail,detail),g=new THREE.SphereBufferGeometry(125/downscale,detail,detail),u=new THREE.SphereBufferGeometry(150/downscale,detail,detail),p=new THREE.SphereBufferGeometry(137.5/downscale,detail,detail),m=new THREE.SphereBufferGeometry(2500/downscale,detail,detail),E=new THREE.SphereBufferGeometry(750/downscale,detail,detail),h=new THREE.SphereBufferGeometry(1e3/downscale,detail,detail),w=new THREE.SphereBufferGeometry(600/downscale,detail,detail),f=new THREE.SphereBufferGeometry(50/downscale,detail,detail);function T(e,t){switch(t){case 0:return e+"_low.png";case 1:return e+"_medium.png";case 2:return e+"_high.png";case 3:return e+"_ultra.png"}}function T(e,t){switch(t){case 0:return e+"_low.png";case 1:return e+"_medium.png";case 2:return e+"_high.png";case 3:return e+"_ultra.png"}}loadingText.innerHTML='Loading assets (this can take a while) (3/12) <div id="loadingpercent"></div>';var M=new THREE.LoadingManager,x=new THREE.TextureLoader(M);M.onProgress=function(e,t,n){try{document.getElementById("loadingpercent").innerText=(t/n*100).toFixed(1)+"%"}catch{}};var v=[],S=[T("assets/sun/sun",settingsData.gq.current),T("assets/merc/merc",settingsData.gq.current),T("assets/vens/vens",settingsData.gq.current),T("assets/erth/erth",settingsData.gq.current),T("assets/mars/mars",settingsData.gq.current),T("assets/jupt/jupt",settingsData.gq.current),T("assets/strn/strn",settingsData.gq.current),T("assets/urns/urns",settingsData.gq.current),T("assets/nept/nept",settingsData.gq.current),T("assets/moon/moon",settingsData.gq.current),"assets/sun/sun_ao.png","assets/merc/merc_ao.png","assets/vens/vens_ao.png","assets/erth/erth_ao.png","assets/mars/mars_ao.png","assets/jupt/jupt_ao.png","assets/strn/strn_ao.png","assets/urns/urns_ao.png","assets/nept/nept_ao.png","assets/moon/moon_ao.png",T("/assets/starfield/starfield",settingsData.sk.current),"assets/sun/sun_ds.png","assets/merc/merc_ds.png","assets/vens/vens_ds.png","assets/erth/erth_ds.png","assets/mars/mars_ds.png","assets/jupt/jupt_ds.png","assets/strn/strn_ds.png","assets/urns/urns_ds.png","assets/nept/nept_ds.png","assets/moon/moon_ds.png"],y=[];S.forEach(function(e){v.push(new Promise(function(t,n){x.load(e,function(e){e.anisotropy=16,t(e)},function(e){},function(t){n(new Error("Could not load "+e))})}))}),await Promise.all(v).then(function(e){y=e,console.log("done!")},function(e){console.error("Could not load all textures:",e)});var H=o.domElement,R=!1,D=0;document.addEventListener("click",function(e){0!=D&&(settingsOn||H.requestPointerLock())});var C=new THREE.Euler(0,0,0,"YXZ"),P=Math.PI/2,O=0,L=0,I=0;loadingText.innerHTML="Loading assets (this can take a while) (4/12)",document.addEventListener("mousemove",function(e){if(!1!==R){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;C.setFromQuaternion(r.quaternion),C.y-=.002*t,C.x-=.002*n,C.x=Math.max(-P,Math.min(P,C.x)),r.quaternion.setFromEuler(C),se.send(JSON.stringify([4,C.x,C.y]))}},!1),document.addEventListener("pointerlockchange",function(){R=document.pointerLockElement===H},!1);var B=new THREE.MeshStandardMaterial({map:y[0],emissiveMap:y[0],emissive:16777215,aoMap:settingsData.ao.current?y[10]:null,displacementMap:settingsData.ptd.current?y[21]:null,displacementScale:-.05}),b=new THREE.MeshStandardMaterial({map:y[1],emissiveMap:y[1],emissive:1118481,aoMap:settingsData.ao.current?y[11]:null,displacementMap:settingsData.ptd.current?y[22]:null,displacementScale:-.05}),_=new THREE.MeshStandardMaterial({map:y[2],emissiveMap:y[2],emissive:1118481,aoMap:settingsData.ao.current?y[12]:null,displacementMap:settingsData.ptd.current?y[23]:null,displacementScale:-.05}),k=new THREE.MeshStandardMaterial({map:y[3],emissiveMap:y[3],emissive:1118481,aoMap:settingsData.ao.current?y[13]:null,displacementMap:settingsData.ptd.current?y[24]:null,displacementScale:-.05}),G=new THREE.MeshStandardMaterial({map:y[4],emissiveMap:y[4],emissive:1118481,aoMap:settingsData.ao.current?y[14]:null,displacementMap:settingsData.ptd.current?y[25]:null,displacementScale:-.05}),N=new THREE.MeshStandardMaterial({map:y[5],emissiveMap:y[5],emissive:1118481,aoMap:settingsData.ao.current?y[15]:null,displacementMap:settingsData.ptd.current?y[26]:null,displacementScale:-.05}),q=new THREE.MeshStandardMaterial({map:y[6],emissiveMap:y[6],emissive:1118481,aoMap:settingsData.ao.current?y[16]:null,displacementMap:settingsData.ptd.current?y[27]:null,displacementScale:-.05}),W=new THREE.MeshStandardMaterial({map:y[7],emissiveMap:y[7],emissive:1118481,aoMap:settingsData.ao.current?y[17]:null,displacementMap:settingsData.ptd.current?y[28]:null,displacementScale:-.05}),j=new THREE.MeshStandardMaterial({map:y[8],emissiveMap:y[8],emissive:1118481,aoMap:settingsData.ao.current?y[18]:null,displacementMap:settingsData.ptd.current?y[29]:null,displacementScale:-.05}),z=new THREE.MeshStandardMaterial({map:y[9],emissiveMap:y[9],emissive:1118481,aoMap:settingsData.ao.current?y[19]:null,displacementMap:settingsData.ptd.current?y[30]:null,displacementScale:-.05});loadingText.innerHTML="Applying (5/12)";var F=new THREE.Mesh(d,B),A=new THREE.Mesh(c,b),U=new THREE.Mesh(g,_),Y=new THREE.Mesh(u,k),J=new THREE.Mesh(p,G),X=new THREE.Mesh(m,N),K=new THREE.Mesh(E,q),Z=new THREE.Mesh(h,W),V=new THREE.Mesh(w,j),Q=new THREE.Mesh(f,z);l.push(F),l.push(A),l.push(U),l.push(Y),l.push(J),l.push(X),l.push(K),l.push(Z),l.push(V),l.push(Q),loadingText.innerHTML="Finishing up world (6/12)";var $=new THREE.PointLight(16777215,1,0,0);l.forEach((e,t)=>{s.add(e)}),s.add($);var ee=new THREE.SphereBufferGeometry(16e4/downscale,256,256),te=new THREE.MeshBasicMaterial({map:y[20]});te.side=THREE.BackSide;var ne=new THREE.Mesh(ee,te);s.add(ne);var ae=x.load("assets/modules/heart.png");loadingText.innerHTML="Estabilishing connection (7/12)";var se=new WebSocket(serverUrl);window.warws=se,se.onerror=function(e){log("Connection error: "+e),log("Current WS state: "+se.readyState)},se.onclose=function(e){log("Disconnected: "+e.code)};var re=0,ie=[];loadingText.innerHTML="Keyboard events (8/12)",document.addEventListener("keydown",function(e){1!=ie[e.keyCode]&&R&&(ie[e.keyCode]=!0,se.send(JSON.stringify([0,e.key,!0])))}),document.addEventListener("keyup",function(e){R&&(ie[e.keyCode]=!1,se.send(JSON.stringify([0,e.key,!1])))});var oe=Math.floor(7*Math.random())+1,le=(new THREE.Euler(0,0,0,"YXZ"),0),de=0;function ce(e){return e<10&&(e="0"+e),e}se.onmessage=function(e){dataPool+=e.data.length;var t=JSON.parse(e.data);switch(t[0]){case 0:D=t[1],a=!0;break;case 1:t[1].forEach((e,t)=>{if(0!=t)try{l[e.c].position.x=e.x/downscale,l[e.c].position.z=e.z/downscale,a||e.c!=oe||(r.position.x=e.x/downscale,r.position.z=e.z/downscale,r.lookAt(l[0].position))}catch{}}),t[2].forEach(e=>{s.children.forEach(t=>{t.userData.id==e.i&&(t.position.x=e.x/downscale,t.position.y=e.y/downscale,t.position.z=e.z/downscale,t.quaternion.x=e.qx,t.quaternion.y=e.qy,t.quaternion.z=e.qz,t.quaternion.w=e.qw,0==e.t&&a&&e.n==D&&(pitchtext.innerText="PITCH: "+(t.rotation.x*(180/Math.PI)).toFixed(2),yawtext.innerText="YAW: "+(t.rotation.y*(180/Math.PI)).toFixed(2),rolltext.innerText="ROLL: "+(t.rotation.z*(180/Math.PI)).toFixed(2),O=e.x/downscale,L=e.z/downscale,I=e.y/downscale))})});break;case 2:var n,i,o=t[1];o.t,n=new THREE.BoxBufferGeometry(10/downscale,10/downscale,10/downscale),i=new THREE.MeshStandardMaterial({map:ae,emissiveMap:ae,emissive:2236962});var d=new THREE.Mesh(n,i),c=new THREE.PointLight(16384e3,1,50/downscale);d.add(c),d.userData.id=o.i,0==o.t&&(d.userData.instance=o.n),d.rotation.order="YXZ",s.add(d);break;case 3:log("<span color='gold'>"+t[1].n+" joined the game</span>");break;case 4:log("<span color='gold'>"+t[1].n+" left the game</span>"),s.children.forEach((e,n)=>{e.userData.instance!=t[1].i&&e.userData.owner!=t[1].i||s.remove(s.children[n])});break;case 5:break;case 6:powertext.innerText="POWER: "+Math.floor(t[1])+"/"+t[2],velocitytext.innerText="VELOCITY: "+t[3],re=Math.max(re,t[3]),powerbar.style.width=t[1]/t[2]*100+"%",velocitybar.style.width=t[3]/re*100+"%";break;case 7:de=t[1],le=Math.floor(dataPool/1024)}return!1},loadingText.innerHTML="Postprocessing (9/12)";var ge=new POSTPROCESSING.EffectComposer(o),ue=new POSTPROCESSING.RenderPass(s,r);ge.addPass(ue);var pe=new POSTPROCESSING.NormalPass(s,r);if(ge.addPass(pe),settingsData.bl.current){var me=new POSTPROCESSING.BloomEffect({texture:B,intensity:.6});me.renderToScreen=!0,ge.addPass(new POSTPROCESSING.EffectPass(r,me))}if(settingsData.gd.current){let e=new POSTPROCESSING.GodRaysEffect(r,F);e.renderToScreen=!0,ge.addPass(new POSTPROCESSING.EffectPass(r,e))}{const e=new POSTPROCESSING.SSAOEffect(r,pe.renderTarget.texture,{blendFunction:POSTPROCESSING.BlendFunction.MULTIPLY,samples:11,rings:4,distanceFalloff:.0025,rangeThreshold:3e-4,rangeFalloff:1e-4,luminanceInfluence:.7,radius:30,scale:1,bias:.05});ge.addPass(new POSTPROCESSING.EffectPass(r,e))}if(settingsData.dof.current){var Ee=new POSTPROCESSING.DepthOfFieldEffect(r);Ee.renderToScreen=!0,ge.addPass(new POSTPROCESSING.EffectPass(r,Ee))}if(0!=settingsData.aa.current){let e=new Image;e.src=POSTPROCESSING.SMAAEffect.areaImageDataURL;let t=new Image;t.src=POSTPROCESSING.SMAAEffect.searchImageDataURL,ge.addPass(new POSTPROCESSING.EffectPass(r,new POSTPROCESSING.SMAAEffect(t,e,settingsData.aa.current-1,POSTPROCESSING.EdgeDetectionMode.DEPTH)))}se.onopen=function(e){joinButton.onclick=function(e){document.getElementById("menu").style.display="none",se.send("0"+playerTextName.value.slice(0,15)),affiliateGlap.style.display="none"}},loadingText.innerHTML="Finishing up (10/12)";var he,we,fe=75,Te=0,Me=0;function xe(){var e,n,s,i;a&&(r.position.x=Math.sin(C.y)*Math.sin(C.x+P)*(fe/downscale)+O,r.position.z=Math.cos(C.y)*Math.sin(C.x+P)*(fe/downscale)+L,r.position.y=-Math.sin(C.x)*(fe/downscale)+I),ge.render(),Te++,performance.now()-we>=1e3&&(we=performance.now(),stats.innerHTML=(e=new Date,n=e.getHours(),s=e.getMinutes(),i=e.getSeconds(),n+":"+(s=ce(s))+":"+(i=ce(i))+" // "+t+" // <span style='color:rgb(48, 179, 30)'>draw call "+Me.toFixed(1)+" ms</span> <span style='color:rgb(22, 127, 219)'>"+Te+" fps</span> <span style='color: rgb(107, 30, 179)'>"+le+" kB/s</span> <span style='color:rgb(24, 240, 121)'>"+de+" players online</span>"),Te=0),he&&(Me=performance.now()-he),he=performance.now(),we||(we=performance.now()),requestAnimationFrame(xe)}loadingText.innerHTML="Init Scene (11/12)",document.addEventListener("wheel",e=>{fe=function(e,t,n){return e<=t?t:e>=n?n:e}(fe+e.deltaY/30,50,1e3)}),loadingText.innerHTML="Done",setTimeout(()=>{xe(),window.planets=l,joinButton.querySelector("div").innerText="Join",joinButton.disabled=!1,loadScreen.style.opacity=0,loadScreen.addEventListener("transitionend",()=>loadScreen.remove())},500)}everysecond(){dataPool=0}}var game=new player;window.game=game,game.init();
